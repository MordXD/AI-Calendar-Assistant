services:
  postgres:
    image: pgvector/pgvector:pg16
    environment:
      POSTGRES_USER: app
      POSTGRES_PASSWORD: app
      POSTGRES_DB: calendar_ai
    ports: ["5432:5432"]
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U app -d calendar_ai"]
      interval: 5s
      timeout: 3s
      retries: 20

  redis:
    image: redis:7
    ports: ["6379:6379"]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 20

  opensearch:
    image: opensearchproject/opensearch:2
    environment:
      discovery.type: single-node
      plugins.security.disabled: "true"
      OPENSEARCH_JAVA_OPTS: "-Xms512m -Xmx512m"
    ports: ["9200:9200"]
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://localhost:9200 >/dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 30

  keycloak:
    image: quay.io/keycloak/keycloak:24.0
    command: ["start-dev", "--import-realm"]
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
    ports: ["8080:8080"]
    volumes:
      - ./keycloak:/opt/keycloak/data/import
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://localhost:8080/health/ready || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 30

  prometheus:
    image: prom/prometheus:latest
    ports: ["9090:9090"]
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'

  grafana:
    image: grafana/grafana:latest
    ports: ["3000:3000"]
    environment:
      GF_SECURITY_ADMIN_PASSWORD: admin
    volumes:
      - grafana-data:/var/lib/grafana

  embedding:
    build: ../services/embedding
    environment:
      DATABASE_URL: postgresql+psycopg://app:app@postgres:5432/calendar_ai
      REDIS_URL: redis://redis:6379/0
      EMBEDDING_MODEL: "bge-small"
      LOG_LEVEL: INFO
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  retrieval:
    build: ../services/retrieval
    environment:
      DATABASE_URL: postgresql+psycopg://app:app@postgres:5432/calendar_ai
      OPENSEARCH_URL: http://opensearch:9200
      REDIS_URL: redis://redis:6379/0
      LOG_LEVEL: INFO
    depends_on:
      postgres:
        condition: service_healthy
      opensearch:
        condition: service_healthy
      redis:
        condition: service_healthy

  api:
    build: ../services/api
    environment:
      DATABASE_URL: postgresql+psycopg://app:app@postgres:5432/calendar_ai
      RETRIEVAL_URL: http://retrieval:8000
      EMBEDDING_URL: http://embedding:8000
      KEYCLOAK_ISSUER: http://keycloak:8080/realms/calendar
      JWKS_URL: http://keycloak:8080/realms/calendar/protocol/openid-connect/certs
      OPENSEARCH_URL: http://opensearch:9200
      REDIS_URL: redis://redis:6379/0
      LOG_LEVEL: INFO
    ports: ["8000:8000"]
    depends_on:
      retrieval:
        condition: service_started
      embedding:
        condition: service_started
      keycloak:
        condition: service_healthy

volumes:
  pgdata:
  grafana-data:
